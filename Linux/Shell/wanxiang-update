#!/usr/bin/env bash

set -euo pipefail

#### é…ç½® Rime éƒ¨ç½²ç›®å½• ####
# æ”¯æŒç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ã€æ‹“å±•å˜é‡
# ä¾‹å¦‚ "/home/user/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "$HOME/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "${XDG_DATA_HOME:-$HOME/.local/share}/fcitx5/rime"

DEPLOY_DIR=""

######### é…ç½®ç»“æŸ #########

# å…¨å±€å˜é‡
SCHEMA_REPO="https://github.com/amzxyz/rime_wanxiang"
GRAM_REPO="https://github.com/amzxyz/RIME-LMDG"
TOOLS_REPO="https://github.com/expoli/rime-wanxiang-update-tools"
SCHEMA_API="https://api.github.com/repos/amzxyz/rime_wanxiang"
GRAM_API="https://api.github.com/repos/amzxyz/RIME-LMDG"
TOOLS_API="https://api.github.com/repos/expoli/rime-wanxiang-update-tools"
FUZHU_LIST=("all" "base" "flypy" "hanxin" "jdh" "moqi" "tiger" "wubi" "zrm")
TEMP_DIR=$(mktemp -d /tmp/wanxiang-update-XXXXXX)
UPDATE_TOOLS_VERSION="DEFAULT_UPDATE_TOOLS_VERSION_TAG"
declare -A SCHEMA_MAP=(
  ["moqi"]="rime-wanxiang-moqi-fuzhu.zip"
  ["flypy"]="rime-wanxiang-flypy-fuzhu.zip"
  ["zrm"]="rime-wanxiang-zrm-fuzhu.zip"
  ["jdh"]="rime-wanxiang-jdh-fuzhu.zip"
  ["tiger"]="rime-wanxiang-tiger-fuzhu.zip"
  ["wubi"]="rime-wanxiang-wubi-fuzhu.zip"
  ["hanxin"]="rime-wanxiang-hanxin-fuzhu.zip"
  ["all"]="rime-wanxiang-all-fuzhu.zip"
  ["base"]="rime-wanxiang-base.zip"
)
declare -A DICT_MAP=(
  ["moqi"]="1-pro-moqi-fuzhu-dicts.zip"
  ["flypy"]="2-pro-flypy-fuzhu-dicts.zip"
  ["zrm"]="3-pro-zrm-fuzhu-dicts.zip"
  ["jdh"]="4-pro-jdh-fuzhu-dicts.zip"
  ["tiger"]="5-pro-tiger-fuzhu-dicts.zip"
  ["wubi"]="6-pro-wubi-fuzhu-dicts.zip"
  ["hanxin"]="7-pro-hanxin-fuzhu-dicts.zip"
  ["all"]="8-pro-all-dicts.zip"
  ["base"]="9-base-dicts.zip"
)

# æ—¥å¿—ä¸é”™è¯¯å¤„ç†
log() {
  local red="\033[0;31m" green="\033[0;32m" yellow="\033[0;33m" nc="\033[0m"
  local level="$1" color="$nc"
  case "$level" in
  INFO) color="$green" ;;
  WARN) color="$yellow" ;;
  ERROR) color="$red" ;;
  esac
  shift
  printf "${color}[%s] %s${nc}\n" "$level" "$*"
}
error_exit() {
  log ERROR "$*"
  cleanup
  exit 1
}
cleanup() {
  if [[ -d "$TEMP_DIR" ]]; then
    rm -rf "$TEMP_DIR" || log WARN "æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥"
  fi
}
deps_check() {
  for _cmd in curl jq unzip sha256sum; do
    command -v "$_cmd" >/dev/null || error_exit "ç¼ºå°‘å¿…è¦ä¾èµ–ï¼š$_cmd"
  done
}
fuzhu_check() {
  local fuzhu_check="$1"
  for _fuzhu in "${FUZHU_LIST[@]}"; do
    if [[ "$fuzhu_check" == "$_fuzhu" ]]; then
      return 0
    fi
  done
  return 1
}
script_check() {
  if [[ "$UPDATE_TOOLS_VERSION" =~ ^"DEFAULT" ]]; then
    log WARN "ä½ ä¼¼ä¹æ­£åœ¨ä½¿ç”¨æºæ–‡ä»¶ï¼"
    log WARN "è¯·ä» $TOOLS_REPO/releases/latest é¡µé¢ä¸‹è½½æ­£å¼ç‰ˆï¼"
    error_exit "ç»ˆæ­¢æ“ä½œ"
  fi
  log INFO "å·¥å…·å½“å‰ç‰ˆæœ¬ $UPDATE_TOOLS_VERSION"
  log INFO "æ­£åœ¨æ£€æŸ¥æœ¬å·¥å…·æ˜¯å¦æœ‰æ›´æ–°"
  local local_version remote_version
  local_version="$UPDATE_TOOLS_VERSION"
  remote_version=$(
    curl -sL --connect-timeout 10 $TOOLS_API/releases |
      jq -r '.[].tag_name' | grep -vE "rc" | sort -rV | head -n 1
  )
  if [[ "$remote_version" > "$local_version" ]]; then
    log WARN "æ£€æµ‹åˆ°å·¥å…·æœ€æ–°ç‰ˆæœ¬ä¸º: $remote_version, å»ºè®®æ›´æ–°åç»§ç»­"
    log WARN "ä½ å¯ä»è¯¥é“¾æ¥ä¸‹è½½: $GH_DL/$UPDATE_TOOLS_REPO/releases/tag/$remote_version"
  else
    log INFO "å·¥å…·å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
  fi
}

update_schema() {
  local fuzhu="$1" gram="$2"
  # è·å–æœ¬åœ°ç‰ˆæœ¬å·
  local local_version remote_version
  if [[ -f "$DEPLOY_DIR/lua/wanxiang.lua" ]]; then
    local_version=$(grep "wanxiang.version" "$DEPLOY_DIR/lua/wanxiang.lua" | awk -F '"' '{print $2}')
  else
    local_version="0"
  fi
  log INFO "å½“å‰æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º v$local_version"
  # è·å–è¿œç¨‹ç‰ˆæœ¬å·
  remote_version=$(
    curl -sL --connect-timeout 10 $SCHEMA_API/releases |
      jq -r '.[].tag_name' | grep -vE "dict-nightly" | sort -rV | head -n 1
  )
  if [[ "$remote_version" > "v$local_version" ]]; then
    log INFO "æ–¹æ¡ˆæ–‡ä»¶æœ€æ–°ç‰ˆæœ¬å·ä¸º $remote_version, ä»¥ä¸‹å†…å®¹ä¸ºæ›´æ–°æ—¥å¿—"
    local changelog
    changelog=$(
      curl -sL --connect-timeout 10 $SCHEMA_API/releases |
        jq -r --arg version "$remote_version" '.[] |
        select(.tag_name == $version ) | .body'
    )
    echo -e "$changelog" | sed -n '/## ğŸ“ æ›´æ–°æ—¥å¿—/,/## ğŸš€ ä¸‹è½½å¼•å¯¼/p' | head -n -1
    sleep 5
    log INFO "å¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶ï¼Œæ­£åœ¨ä¸‹è½½æ–‡ä»¶"
    curl -L --connect-timeout 10 -o "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]}" \
      "$SCHEMA_REPO/releases/download/$remote_version/${SCHEMA_MAP[$fuzhu]}"
    log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
    local local_sha256sum remote_sha256sum
    local_sha256sum=$(sha256sum "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]}" | awk '{print $1}')
    remote_sha256sum=$(
      curl -sL --connect-timeout 10 $SCHEMA_API/releases |
        jq -r --arg version "$remote_version" --arg fuzhu "$fuzhu" '.[] |
        select(.tag_name == $version) | .assets.[] |
        select(.name | test($fuzhu)) | .digest' | awk -F ':' '{print $2}'
    )
    [[ "$local_sha256sum" == "$remote_sha256sum" ]] || error_exit "æ–¹æ¡ˆæ–‡ä»¶ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶"
    unzip -q "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]}" -d "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]%.zip}"
    rm -r "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]%.zip}"/{ç®€çº¯.trime.yaml,custom_phrase.txt,squirrel.yaml,weasel.yaml}
    local exclude_file
    while IFS= read -r _line; do
      exclude_file="$_line"
      if [[ ! -e "$DEPLOY_DIR/$exclude_file" ]]; then
        log WARN "é¡¹ç›® $DEPLOY_DIR/$exclude_file ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½ï¼"
      else
        cp -rf "$DEPLOY_DIR/$exclude_file" "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]%.zip}/$exclude_file"
      fi
    done <"$DEPLOY_DIR/user_exclude_file.txt"
    # å•ç‹¬å¤„ç†è¯­æ³•æ¨¡å‹
    [[ "$gram" == "true" ]] || cp -rf "$DEPLOY_DIR/wanxiang-lts-zh-hans.gram" \
      "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]%.zip}/wanxiang-lts-zh-hans.gram"
    rm -rf "${DEPLOY_DIR:?}"
    cp -rf "$TEMP_DIR/${SCHEMA_MAP[$fuzhu]%.zip}" "${DEPLOY_DIR}"
    log INFO "æ–¹æ¡ˆæ–‡ä»¶æ›´æ–°æˆåŠŸ"
  else
    log INFO "æ–¹æ¡ˆæ–‡ä»¶æ— éœ€æ›´æ–°"
  fi
}
update_dict() {
  local fuzhu="$1"
  log INFO "æ­£åœ¨ä¸‹è½½æœ€æ–°è¯å…¸æ–‡ä»¶"
  curl -L --connect-timeout 10 -o "$TEMP_DIR/${DICT_MAP[$fuzhu]}" \
    "$SCHEMA_REPO/releases/download/dict-nightly/${DICT_MAP[$fuzhu]}"
  log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
  local local_sha256sum remote_sha256sum
  local_sha256sum=$(sha256sum "$TEMP_DIR/${DICT_MAP[$fuzhu]}" | awk '{print $1}')
  remote_sha256sum=$(
    curl -sL --connect-timeout 10 $SCHEMA_API/releases |
      jq -r --arg version "dict-nightly" --arg fuzhu "$fuzhu" '.[] |
      select(.tag_name == $version ) | .assets.[] |
      select(.name | test($fuzhu)) | .digest' | awk -F ':' '{print $2}'
  )
  [[ "$local_sha256sum" == "$remote_sha256sum" ]] || error_exit "è¯å…¸æ–‡ä»¶ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
  log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°è¯å…¸æ–‡ä»¶"
  unzip -q "$TEMP_DIR/${DICT_MAP[$fuzhu]}" -d "$TEMP_DIR"
  local dict_dir
  dict_dir="${DICT_MAP[$fuzhu]:2}"
  dict_dir="${dict_dir%.zip}"
  cp -rf "$TEMP_DIR/$dict_dir"/* "${DEPLOY_DIR}/dicts"
  log INFO "è¯å…¸æ–‡ä»¶æ›´æ–°æˆåŠŸ"
}
update_gram() {
  log INFO "æ­£åœ¨ä¸‹è½½æœ€æ–°è¯­æ³•æ¨¡å‹"
  curl -L --connect-timeout 10 -o "$TEMP_DIR/wanxiang-lts-zh-hans.gram" \
    "$GRAM_REPO/releases/download/LTS/wanxiang-lts-zh-hans.gram"
  log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
  local local_sha256sum remote_sha256sum
  local_sha256sum=$(sha256sum "$TEMP_DIR/wanxiang-lts-zh-hans.gram" | awk '{print $1}')
  remote_sha256sum=$(
    curl -sL --connect-timeout 10 $GRAM_API/releases |
      jq -r --arg version "LTS" --arg gramname "wanxiang-lts-zh-hans.gram" '.[] |
      select(.tag_name == $version) | .assets.[] |
      select(.name == $gramname) | .digest' | awk -F ':' '{print $2}'
  )
  [[ "$local_sha256sum" == "$remote_sha256sum" ]] || error_exit "è¯­æ³•æ¨¡å‹ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
  log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹è¯­æ³•æ¨¡å‹æ–‡ä»¶"
  cp -rf "$TEMP_DIR/wanxiang-lts-zh-hans.gram" "${DEPLOY_DIR}/wanxiang-lts-zh-hans.gram"
  log INFO "è¯­æ³•æ¨¡å‹æ›´æ–°æˆåŠŸ"
}

main() {
  # è„šæœ¬é€€å‡ºæ¸…ç†ä¸´æ—¶ç›®å½•
  trap cleanup EXIT
  # æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
  if [[ "$EUID" -eq 0 ]]; then
    error_exit "è¯·ä¸è¦ä½¿ç”¨ root èº«ä»½è¿è¡Œè¯¥è„šæœ¬ï¼"
  fi
  # æ£€æŸ¥å¿…è¦çš„ä¾èµ–
  deps_check
  # è„šæœ¬è‡ªæ£€
  script_check
  # å¤„ç†ç”¨æˆ·è¾“å…¥
  local schema="" fuzhu="" dict="false" gram="false"
  # è§£æå‘½ä»¤è¡Œå‚æ•°
  while [[ "$#" -gt 0 ]]; do
    case $1 in
    --schema)
      if [[ -n "$schema" ]]; then
        error_exit "é€‰é¡¹ scheam éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "base" && "$1" != "pro" ]]; then
        error_exit "é€‰é¡¹ scheam çš„å‚æ•°åªèƒ½ä¸º base æˆ– pro"
      else
        schema="$1"
      fi
      ;;
    --fuzhu)
      if [[ -n "$fuzhu" ]]; then
        error_exit "é€‰é¡¹ fuzhu éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if fuzhu_check "$1"; then
        fuzhu="$1"
      else
        error_exit "é€‰é¡¹ fuzhu çš„å‚æ•°åªèƒ½ä¸º ${FUZHU_LIST[*]} å…¶ä¸­ä¹‹ä¸€"
      fi
      ;;
    --dict)
      dict="true"
      ;;
    --gram)
      gram="true"
      ;;
    *)
      log WARN "ä½ å¯èƒ½é”™è¯¯çš„ä½¿ç”¨äº†è¯¥è„šæœ¬"
      log WARN "è¯·å‰å¾€ GitHub é¡µé¢é˜…è¯» Readme"
      log WARN "ç›´è¾¾é“¾æ¥ï¼š$TOOLS_REPO/blob/main/Linux/Shell/README.md"
      error_exit "å‚æ•°è¾“å…¥é”™è¯¯: $1"
      ;;
    esac
    shift
  done
  # åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†éƒ¨ç½²ç›®å½•
  if [[ -n "$DEPLOY_DIR" ]]; then
    if [[ ! -d "$DEPLOY_DIR" ]]; then
      log WARN "éƒ¨ç½²ç›®å½• $DEPLOY_DIR ä¸å­˜åœ¨ï¼Œä½ è¦åˆ›å»ºå®ƒå—ï¼Ÿ"
      read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™) " _check
      if [[ "$_check" == "YES" ]]; then
        log WARN "ä½ çœŸçš„è¦åˆ›å»ºè¯¥ç›®å½•å—ï¼Ÿä½ ç¡®å®šä½ çš„è®¾ç½®æ­£ç¡®å—ï¼Ÿ"
        read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™) " _check_again
        [[ "$_check_again" == "YES" ]] || error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
        mkdir -p "$DEPLOY_DIR"
      else
        error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
      fi
    fi
  else
    error_exit "è¯·è®¾ç½®éƒ¨ç½²ç›®å½•ï¼"
  fi
  # æ’é™¤é¡¹ç›®åˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if [[ ! -f "$DEPLOY_DIR/user_exclude_file.txt" ]]; then
    log WARN "ä½ æ²¡æœ‰è®¾ç½®æ’é™¤é¡¹ç›®åˆ—è¡¨ï¼"
    log WARN "ä½ éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ä¸º $DEPLOY_DIR/user_exclude_file.txt"
    log WARN "è¯·åœ¨è¯¥æ–‡ä»¶ä¸­å†™å…¥ä½ éœ€è¦æ’é™¤çš„é¡¹ç›®ï¼Œæ¯è¡Œä¸€ä¸ª"
    log WARN "å¦‚æœä½ ç¡®å®ä¸éœ€è¦æ’é™¤ä»»ä½•æ–‡ä»¶ï¼Œè¯·åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶æ¥æŠ‘åˆ¶è¯¥è­¦å‘Š"
    log WARN "æ›´å¤šå†…å®¹è¯·å‚é˜…ï¼š$TOOLS_REPO/blob/main/Linux/Shell/README.md"
    error_exit "$DEPLOY_DIR/user_exclude_file.txt æ–‡ä»¶ä¸å­˜åœ¨"
  fi
  # æ£€æŸ¥ schema å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ -n "$schema" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ schema ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi
  # æ£€æŸ¥ dict å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ "$dict" == "true" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ dict ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi
  # æ£€æŸ¥å½“ schema ä¸º base æ—¶ï¼Œfuzhu æ˜¯å¦ä¹Ÿä¸º base
  if [[ "$schema" == "base" && "$fuzhu" != "base" ]]; then
    error_exit "å½“é€‰é¡¹ schema ä¸º base æ—¶ï¼Œé€‰é¡¹ fuzhu å¿…é¡»ä¸º base"
  fi
  [[ -z "$schema" ]] || update_schema "$fuzhu" "$gram"
  [[ "$dict" == "false" ]] || update_dict "$fuzhu"
  [[ "$gram" == "false" ]] || update_gram
  # æç¤ºç”¨æˆ·é‡æ–°è¿›è¡Œéƒ¨ç½²
  log INFO "æ›´æ–°å®Œæˆï¼Œè¯·é‡æ–°éƒ¨ç½² rime"
  # Fcitx5+Plasma (KDE) ç”¨æˆ·å¯å–æ¶ˆä»¥ä¸‹æ³¨é‡Šæ¥è‡ªåŠ¨éƒ¨ç½²
  # if command -v qdbus6 >/dev/null; then
  #   qdbus6 org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.SetConfig "fcitx://config/addon/rime/deploy" ""
  # fi
}

main "$@"
