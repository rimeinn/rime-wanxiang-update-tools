#!/usr/bin/env bash

set -euo pipefail

#### é…ç½® Rime éƒ¨ç½²ç›®å½• ####
# æ”¯æŒç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ã€æ‹“å±•å˜é‡
# ä¾‹å¦‚ "/home/user/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "$HOME/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "${XDG_DATA_HOME:-$HOME/.local/share}/fcitx5/rime"

DEPLOY_DIR=""

######### é…ç½®ç»“æŸ #########

# å…¨å±€å˜é‡
CNB_API="https://cnb.cool/amzxyz/rime-wanxiang/-/releases"
SCHEMA_API="https://api.github.com/repos/amzxyz/rime_wanxiang/releases"
GRAM_API="https://api.github.com/repos/amzxyz/RIME-LMDG/releases"
TOOLS_API="https://api.github.com/repos/rimeinn/rime-wanxiang-update-tools/releases"
FUZHU_LIST=("base" "flypy" "hanxin" "moqi" "tiger" "wubi" "zrm")
TEMP_DIR=$(mktemp -d /tmp/wanxiang-update-XXXXXX)
UPDATE_TOOLS_VERSION="DEFAULT_UPDATE_TOOLS_VERSION_TAG"

# æ—¥å¿—ä¸é”™è¯¯å¤„ç†
log() {
  local red="\033[0;31m" green="\033[0;32m" yellow="\033[0;33m" nc="\033[0m"
  local level="$1" color="$nc"
  case "$level" in
  INFO) color="$green" ;;
  WARN) color="$yellow" ;;
  ERROR) color="$red" ;;
  esac
  shift
  printf "${color}[%s] %s${nc}\n" "$level" "$*"
}
error_exit() {
  log ERROR "$*"
  cleanup
  exit 1
}
cleanup() {
  if [[ -d "$TEMP_DIR" ]]; then
    rm -rf "$TEMP_DIR" || log WARN "æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥"
  fi
}
deps_check() {
  for _cmd in curl jq unzip; do
    command -v "$_cmd" >/dev/null || error_exit "ç¼ºå°‘å¿…è¦ä¾èµ–ï¼š$_cmd"
  done
}
fuzhu_check() {
  local fuzhu_check="$1"
  for _fuzhu in "${FUZHU_LIST[@]}"; do
    if [[ "$fuzhu_check" == "$_fuzhu" ]]; then
      return 0
    fi
  done
  return 1
}
script_check() {
  local mirror="$1"
  if [[ "$UPDATE_TOOLS_VERSION" =~ ^"DEFAULT" ]]; then
    log WARN "æ‚¨ä¼¼ä¹æ­£åœ¨ä½¿ç”¨æºæ–‡ä»¶ï¼"
    log WARN "è¯·ä» Release é¡µé¢ä¸‹è½½æ­£å¼ç‰ˆï¼"
    error_exit "ç»ˆæ­¢æ“ä½œ"
  fi
  log INFO "å·¥å…·å½“å‰ç‰ˆæœ¬ $UPDATE_TOOLS_VERSION"
  if [[ "$mirror" == "github" ]]; then
    # æ£€æŸ¥ GitHub è¿æ¥çŠ¶æ€
    log INFO "æ­£åœ¨æ£€æŸ¥ GitHub è¿æ¥çŠ¶æ€"
    if ! curl -sL --connect-timeout 5 "https://api.github.com" >/dev/null; then
      error_exit "æ‚¨ä¼¼ä¹æ— æ³•è¿æ¥åˆ° GitHub API, è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ"
    elif ! curl -sL --connect-timeout 5 "https://github.com" >/dev/null; then
      error_exit "æ‚¨ä¼¼ä¹æ— æ³•è¿æ¥åˆ° GitHub, è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ"
    fi
    log INFO "æ­£åœ¨æ£€æŸ¥æœ¬å·¥å…·æ˜¯å¦å­˜åœ¨æ›´æ–°"
    local local_version remote_version
    local_version="$UPDATE_TOOLS_VERSION"
    remote_version=$(
      curl -sL --connect-timeout 10 $TOOLS_API |
        jq -r '.[].tag_name' | grep -vE "rc" | sort -rV | head -n 1
    )
    if [[ "$remote_version" > "$local_version" ]]; then
      log WARN "æ£€æµ‹åˆ°å·¥å…·æœ€æ–°ç‰ˆæœ¬ä¸º: $remote_version, å»ºè®®æ›´æ–°åç»§ç»­"
      log WARN "https://github.com/rimeinn/rime-wanxiang-update-tools/releases/download/$remote_version/rime-wanxiang-update-linux"
    else
      log INFO "å·¥å…·å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    log WARN "ç”±äºæ‚¨æ­£åœ¨ä½¿ç”¨é•œåƒï¼Œæ— æ³•æ£€æŸ¥æœ¬å·¥å…·æ˜¯å¦å­˜åœ¨æ›´æ–°"
  fi
}

get_info() {
  local mirror="$1" version="$2" name="$3" info
  if [[ "$mirror" == "github" ]]; then
    info=$(
      jq -r --arg version "$version" --arg name "$name" '.[] |
      select( .tag_name == $version ) | .assets.[] |
      select( .name | test( $name ) )' "$TEMP_DIR/github_$name.json"
    )
    echo "$info"
  elif [[ "$mirror" == "cnb" ]]; then
    info=$(
      jq -r --arg version "refs/tags/$version" --arg name "$name" '.releases.[] |
      select( .tag_ref == $version ) | .assets[] |
      select( .name | test( $name ) )' "$TEMP_DIR/cnb.json"
    )
    echo "$info"
  fi
}

update_schema() {
  local mirror="$1" fuzhu="$2" gram="$3"
  # ç¼“å­˜ API å“åº”
  if [[ "$mirror" == "github" ]]; then
    if [[ ! -f "$TEMP_DIR/github_$fuzhu.json" ]]; then
      if ! curl -sL -H "Accept: application/vnd.github.v3+json" \
        --connect-timeout 10 "$SCHEMA_API" >"$TEMP_DIR/github_$fuzhu.json"; then
        error_exit "è¿æ¥åˆ° GitHub API å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    if [[ ! -f "$TEMP_DIR/cnb.json" ]]; then
      if ! curl -sL -H "accept: application/vnd.cnb.web+json" \
        --connect-timeout 10 "$CNB_API" >"$TEMP_DIR/cnb.json"; then
        error_exit "è¿æ¥åˆ° CNB å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  fi
  # è·å–æœ¬åœ°ç‰ˆæœ¬å·
  local local_version remote_version
  if [[ -f "$DEPLOY_DIR/lua/wanxiang.lua" ]]; then
    local_version=$(grep "wanxiang.version" "$DEPLOY_DIR/lua/wanxiang.lua" | awk -F '"' '{print $2}')
    [[ "$local_version" == v* ]] || local_version="v$local_version"
  else
    local_version="v0"
  fi
  # è·å–è¿œç¨‹ç‰ˆæœ¬å·
  if [[ "$mirror" == "github" ]]; then
    remote_version=$(
      jq -r '.[].tag_name' "$TEMP_DIR/github_$fuzhu.json" |
        grep -vE "dict-nightly" | sort -rV | head -n 1
    )
  elif [[ "$mirror" == "cnb" ]]; then
    remote_version=$(
      jq -r '.releases.[].tag_ref' \
        "$TEMP_DIR/cnb.json" | grep -vE "model" | sort -rV | head -n 1
    )
    remote_version="${remote_version#"refs/tags/"}"
  fi
  [[ "$remote_version" == v* ]] || remote_version="v$remote_version"
  if [[ "$remote_version" > "$local_version" ]]; then
    log INFO "è¿œç¨‹æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $remote_version, ä»¥ä¸‹å†…å®¹ä¸ºæ›´æ–°æ—¥å¿—"
    local changelog
    if [[ "$mirror" == "github" ]]; then
      changelog=$(
        jq -r --arg version "$remote_version" '.[] |
        select( .tag_name == $version ) | .body' "$TEMP_DIR/github_$fuzhu.json"
      )
    elif [[ "$mirror" == "cnb" ]]; then
      changelog=$(
        jq -r --arg version "refs/tags/$remote_version" '.releases.[] |
        select( .tag_ref == $version ) | .body' "$TEMP_DIR/cnb.json"
      )
    fi
    echo -e "$changelog" | sed -n '/## ğŸ“ æ›´æ–°æ—¥å¿—/,/## ğŸš€ ä¸‹è½½å¼•å¯¼/p' | head -n -1
    sleep 3
    log INFO "å¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶ï¼Œæ­£åœ¨ä¸‹è½½æ–‡ä»¶"
    local schemaurl schemaname local_size remote_size
    if [[ "$mirror" == "github" ]]; then
      schemaurl=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.browser_download_url')
    elif [[ "$mirror" == "cnb" ]]; then
      schemaurl=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.path')
      schemaurl="https://cnb.cool$schemaurl"
    fi
    schemaname=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.name')
    curl -L --connect-timeout 10 -o "$TEMP_DIR/$schemaname" "$schemaurl"
    log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
    local_size=$(stat -c %s "$TEMP_DIR/$schemaname")
    if [[ "$mirror" == "github" ]]; then
      remote_size=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.size')
    elif [[ "$mirror" == "cnb" ]]; then
      remote_size=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.size_in_byte')
    fi
    if [[ "$local_size" != "$remote_size" ]]; then
      log ERROR "æœŸæœ›æ–‡ä»¶å¤§å°: $remote_size, å®é™…æ–‡ä»¶å¤§å°: $local_size"
      error_exit "æ–¹æ¡ˆæ–‡ä»¶ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
    fi
    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶"
    unzip -q "$TEMP_DIR/$schemaname" -d "$TEMP_DIR/${schemaname%.zip}"
    for _file in "ç®€çº¯+.trime.yaml" "custom_phrase.txt" "squirrel.yaml" "weasel.yaml"; do
      if [[ -f "$TEMP_DIR/${schemaname%.zip}/$_file" ]]; then
        rm -r "$TEMP_DIR/${schemaname%.zip}/${_file:?}"
      fi
    done
    local exclude_file
    while IFS= read -r _line; do
      if [[ "$_line" != \#* ]]; then
        exclude_file="$_line"
        if [[ ! -e "$DEPLOY_DIR/$exclude_file" ]]; then
          log WARN "é¡¹ç›® $DEPLOY_DIR/$exclude_file ä¸å­˜åœ¨ï¼Œè·³è¿‡å¤‡ä»½ï¼"
        else
          cp -rf "$DEPLOY_DIR/$exclude_file" "$TEMP_DIR/${schemaname%.zip}/$exclude_file"
        fi
      fi
    done <"$DEPLOY_DIR/custom/user_exclude_file.txt"
    # å•ç‹¬å¤„ç†è¯­æ³•æ¨¡å‹
    [[ "$gram" == "true" ]] || cp -rf "$DEPLOY_DIR/wanxiang-lts-zh-hans.gram" \
      "$TEMP_DIR/${schemaname%.zip}/wanxiang-lts-zh-hans.gram"
    rm -rf "${DEPLOY_DIR:?}"
    cp -rf "$TEMP_DIR/${schemaname%.zip}" "$DEPLOY_DIR"
    log INFO "æ–¹æ¡ˆæ–‡ä»¶æ›´æ–°æˆåŠŸ"
  else
    log INFO "è¿œç¨‹æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $remote_version"
    log INFO "æœ¬åœ°æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $local_version, æ‚¨ç›®å‰æ— éœ€æ›´æ–°å®ƒ"
  fi
}
update_dict() {
  local mirror="$1" fuzhu="$2"
  # ç¼“å­˜ API å“åº”
  if [[ "$mirror" == "github" ]]; then
    if [[ ! -f "$TEMP_DIR/github_$fuzhu.json" ]]; then
      if ! curl -sL -H "Accept: application/vnd.github.v3+json" \
        --connect-timeout 10 "$SCHEMA_API" >"$TEMP_DIR/github_$fuzhu.json"; then
        error_exit "è¿æ¥åˆ° GitHub API å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    if [[ ! -f "$TEMP_DIR/cnb.json" ]]; then
      if ! curl -sL -H "accept: application/vnd.cnb.web+json" \
        --connect-timeout 10 "$CNB_API" >"$TEMP_DIR/cnb.json"; then
        error_exit "è¿æ¥åˆ° CNB å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  fi
  local local_date remote_date
  if [[ -f "$DEPLOY_DIR/dicts/chengyu.txt" ]]; then
    local_date=$(stat -c %Z "$DEPLOY_DIR/dicts/chengyu.txt")
  else
    local_date=0
  fi
  if [[ "$mirror" == "github" ]]; then
    remote_date=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.updated_at')
  elif [[ "$mirror" == "cnb" ]]; then
    remote_date=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.updated_at')
  fi
  remote_date=$(date -d "$remote_date" +%s)
  if [[ $remote_date -gt $local_date ]]; then
    log INFO "æ­£åœ¨ä¸‹è½½æœ€æ–°è¯å…¸æ–‡ä»¶"
    local dicturl dictname local_size remote_size
    if [[ "$mirror" == "github" ]]; then
      dicturl=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.browser_download_url')
      dictname=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.name')
    elif [[ "$mirror" == "cnb" ]]; then
      dicturl=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.path')
      dicturl="https://cnb.cool$dicturl"
      dictname=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.name')
    fi
    curl -L --connect-timeout 10 -o "$TEMP_DIR/$dictname" "$dicturl"
    log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
    local_size=$(stat -c %s "$TEMP_DIR/$dictname")
    if [[ "$mirror" == "github" ]]; then
      remote_size=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.size')
    elif [[ "$mirror" == "cnb" ]]; then
      remote_size=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.size_in_byte')
    fi
    if [[ "$local_size" != "$remote_size" ]]; then
      log ERROR "æœŸæœ›æ–‡ä»¶å¤§å°: $remote_size, å®é™…æ–‡ä»¶å¤§å°: $local_size"
      error_exit "è¯å…¸æ–‡ä»¶ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
    fi
    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°è¯å…¸æ–‡ä»¶"
    unzip -q "$TEMP_DIR/$dictname" -d "$TEMP_DIR"
    dictname="${dictname:2}" && dictname="${dictname%.zip}"
    cp -rf "$TEMP_DIR/$dictname"/* "$DEPLOY_DIR/dicts"
    log INFO "è¯å…¸æ–‡ä»¶æ›´æ–°æˆåŠŸ"
  else
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $remote_date"
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $local_date, æ‚¨ç›®å‰æ— éœ€æ›´æ–°å®ƒ"
  fi
}
update_gram() {
  local mirror="$1"
  # ç¼“å­˜ API å“åº”
  if [[ "$mirror" == "github" ]]; then
    if [[ ! -f "$TEMP_DIR/github_gram.json" ]]; then
      if ! curl -sL -H "Accept: application/vnd.github.v3+json" \
        --connect-timeout 10 "$GRAM_API" >"$TEMP_DIR/github_gram.json"; then
        error_exit "è¿æ¥åˆ° GitHub API å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    if [[ ! -f "$TEMP_DIR/cnb.json" ]]; then
      if ! curl -sL -H "accept: application/vnd.cnb.web+json" \
        --connect-timeout 10 "$CNB_API" >"$TEMP_DIR/cnb.json"; then
        error_exit "è¿æ¥åˆ° CNB å¤±è´¥ï¼Œæ‚¨å¯èƒ½éœ€è¦æ£€æŸ¥ç½‘ç»œ"
      fi
    fi
  fi
  local local_date remote_date gramname="wanxiang-lts-zh-hans.gram"
  if [[ -f "$DEPLOY_DIR/$gramname" ]]; then
    local_date=$(stat -c %Z "$DEPLOY_DIR/$gramname")
  else
    local_date=0
  fi
  if [[ "$mirror" == "github" ]]; then
    remote_date=$(get_info "$mirror" "LTS" "gram" | jq -r '.updated_at')
  elif [[ "$mirror" == "cnb" ]]; then
    remote_date=$(get_info "$mirror" "model" "gram" | jq -r '.updated_at')
  fi
  remote_date=$(date -d "$remote_date" +%s)
  if [[ $remote_date -gt $local_date ]]; then
    log INFO "æ­£åœ¨ä¸‹è½½æœ€æ–°è¯­æ³•æ¨¡å‹"
    local gramurl local_size remote_size
    if [[ "$mirror" == "github" ]]; then
      gramurl=$(get_info "$mirror" "LTS" "gram" | jq -r '.browser_download_url')
    elif [[ "$mirror" == "cnb" ]]; then
      gramurl=$(get_info "$mirror" "model" "gram" | jq -r '.path')
      gramurl="https://cnb.cool$gramurl"
    fi
    curl -L --connect-timeout 10 -o "$TEMP_DIR/$gramname" "$gramurl"
    log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
    local_size=$(stat -c %s "$TEMP_DIR/$gramname")
    if [[ "$mirror" == "github" ]]; then
      remote_size=$(get_info "$mirror" "LTS" "gram" | jq -r '.size')
    elif [[ "$mirror" == "cnb" ]]; then
      remote_size=$(get_info "$mirror" "model" "gram" | jq -r '.size_in_byte')
    fi
    if [[ "$local_size" != "$remote_size" ]]; then
      log ERROR "æœŸæœ›æ–‡ä»¶å¤§å°: $remote_size, å®é™…æ–‡ä»¶å¤§å°: $local_size"
      error_exit "è¯­æ³•æ¨¡å‹ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
    fi
    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°è¯­æ³•æ¨¡å‹"
    cp -rf "$TEMP_DIR/$gramname" "${DEPLOY_DIR}/$gramname"
    log INFO "è¯­æ³•æ¨¡å‹æ›´æ–°æˆåŠŸ"
  else
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $remote_date"
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $local_date, æ‚¨ç›®å‰æ— éœ€æ›´æ–°å®ƒ"
  fi
}

main() {
  # è„šæœ¬é€€å‡ºæ¸…ç†ä¸´æ—¶ç›®å½•
  trap cleanup EXIT
  # æ¬¢è¿è¯­
  log INFO "æ¬¢è¿ä½¿ç”¨ä¸‡è±¡æ–¹æ¡ˆæ›´æ–°åŠ©æ‰‹"
  # æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
  if [[ "$EUID" -eq 0 ]]; then
    error_exit "è¯·ä¸è¦ä½¿ç”¨ root èº«ä»½è¿è¡Œè¯¥è„šæœ¬ï¼"
  fi
  # æ£€æŸ¥å¿…è¦çš„ä¾èµ–
  deps_check
  # å¤„ç†ç”¨æˆ·è¾“å…¥
  local mirror="" depdir="" inputime="" schema="" fuzhu="" dict="false" gram="false"
  # è§£æå‘½ä»¤è¡Œå‚æ•°
  while [[ "$#" -gt 0 ]]; do
    case $1 in
    --mirror)
      if [[ -n "$mirror" ]]; then
        error_exit "é€‰é¡¹ mirror éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "cnb" ]]; then
        error_exit "é€‰é¡¹ mirror çš„å‚æ•°ç›®å‰åªèƒ½ä¸º cnb"
      else
        mirror="$1"
      fi
      ;;
    --depdir)
      if [[ -n "$depdir" ]]; then
        error_exit "é€‰é¡¹ depdir éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      DEPLOY_DIR="$1"
      ;;
    --inputime)
      if [[ -n "$inputime" ]]; then
        error_exit "é€‰é¡¹ inputime éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "fcitx5" && "$1" != "ibus" ]]; then
        error_exit "é€‰é¡¹ inputime çš„å‚æ•°åªèƒ½ä¸º fcitx5 æˆ– ibus"
      else
        inputime="$1"
      fi
      ;;
    --schema)
      if [[ -n "$schema" ]]; then
        error_exit "é€‰é¡¹ schema éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "base" && "$1" != "pro" ]]; then
        error_exit "é€‰é¡¹ schema çš„å‚æ•°åªèƒ½ä¸º base æˆ– pro"
      else
        schema="$1"
      fi
      ;;
    --fuzhu)
      if [[ -n "$fuzhu" ]]; then
        error_exit "é€‰é¡¹ fuzhu éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if fuzhu_check "$1"; then
        fuzhu="$1"
      else
        error_exit "é€‰é¡¹ fuzhu çš„å‚æ•°åªèƒ½ä¸º ${FUZHU_LIST[*]} å…¶ä¸­ä¹‹ä¸€"
      fi
      ;;
    --dict)
      dict="true"
      ;;
    --gram)
      gram="true"
      ;;
    *)
      log WARN "æ‚¨å¯èƒ½é”™è¯¯çš„ä½¿ç”¨äº†è¯¥è„šæœ¬"
      log WARN "è¯·å‰å¾€ GitHub é¡µé¢é˜…è¯» Readme"
      log WARN "https://github.com/rimeinn/rime-wanxiang-update-tools/blob/main/Linux/Shell/README.md"
      error_exit "å‚æ•°è¾“å…¥é”™è¯¯: $1"
      ;;
    esac
    shift
  done
  # åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†éƒ¨ç½²ç›®å½•
  if [[ -n "$DEPLOY_DIR" ]]; then
    if [[ ! -d "$DEPLOY_DIR" ]]; then
      log WARN "éƒ¨ç½²ç›®å½• $DEPLOY_DIR ä¸å­˜åœ¨ï¼Œæ‚¨è¦åˆ›å»ºå®ƒå—ï¼Ÿ"
      read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™) " _check
      if [[ "$_check" == "YES" ]]; then
        log WARN "æ‚¨çœŸçš„è¦åˆ›å»ºè¯¥ç›®å½•å—ï¼Ÿæ‚¨ç¡®å®šæ‚¨çš„è®¾ç½®æ­£ç¡®å—ï¼Ÿ"
        read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™) " _check_again
        [[ "$_check_again" == "YES" ]] || error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
        mkdir -p "$DEPLOY_DIR"
      else
        error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
      fi
    fi
  else
    error_exit "è¯·è®¾ç½®éƒ¨ç½²ç›®å½•ï¼"
  fi
  # æ’é™¤é¡¹ç›®åˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  if [[ -f "$DEPLOY_DIR/user_exclude_file.txt" ]]; then
    mv "$DEPLOY_DIR/user_exclude_file.txt" "$DEPLOY_DIR/custom/user_exclude_file.txt"
    sed -i 's/user_exclude_file\.txt/custom\/user_exclude_file\.txt/g' \
      "$DEPLOY_DIR/custom/user_exclude_file.txt"
  fi
  if [[ ! -f "$DEPLOY_DIR/custom/user_exclude_file.txt" ]]; then
    log WARN "æ‚¨æ²¡æœ‰è®¾ç½®æ’é™¤é¡¹ç›®åˆ—è¡¨ï¼"
    log WARN "æ‚¨éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ä¸º $DEPLOY_DIR/custom/user_exclude_file.txt"
    log WARN "è¯·åœ¨è¯¥æ–‡ä»¶ä¸­å†™å…¥æ‚¨éœ€è¦æ’é™¤çš„é¡¹ç›®ï¼Œæ¯è¡Œä¸€ä¸ª"
    error_exit "$DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶ä¸å­˜åœ¨"
  fi
  # æ£€æŸ¥ schema å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ -n "$schema" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ schema ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi
  # æ£€æŸ¥ dict å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ "$dict" == "true" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ dict ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi
  # æ£€æŸ¥å½“ schema ä¸º base æ—¶ï¼Œfuzhu æ˜¯å¦ä¹Ÿä¸º base
  if [[ "$schema" == "base" && "$fuzhu" != "base" ]]; then
    error_exit "å½“é€‰é¡¹ schema ä¸º base æ—¶ï¼Œé€‰é¡¹ fuzhu å¿…é¡»ä¸º base"
  fi
  [[ -n "$mirror" ]] || mirror="github"
  # è„šæœ¬è‡ªæ£€
  script_check "$mirror"
  # å¼€å§‹æ›´æ–°
  local needed_deploy="false"
  [[ -z "$schema" ]] || update_schema "$mirror" "$fuzhu" "$gram" && needed_deploy="true"
  [[ "$dict" == "false" ]] || update_dict "$mirror" "$fuzhu" && needed_deploy="true"
  [[ "$gram" == "false" ]] || update_gram "$mirror" && needed_deploy="true"
  # è‡ªåŠ¨éƒ¨ç½²
  if [[ "$needed_deploy" == "true" ]]; then
    if [[ "$inputime" == "fcitx5" ]]; then
      if command -v qdbus6 >/dev/null; then
        log INFO "æ›´æ–°å®Œæˆã€‚å·²æ£€æµ‹åˆ° Fcitx5 å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£åœ¨è‡ªåŠ¨éƒ¨ç½²"
        qdbus6 org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.SetConfig "fcitx://config/addon/rime/deploy" ""
      fi
    elif [[ "$inputime" == "ibus" ]]; then
      if command -v ibus-daemon >/dev/null; then
        log INFO "æ›´æ–°å®Œæˆã€‚å·²æ£€æµ‹åˆ° iBus å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£åœ¨è‡ªåŠ¨éƒ¨ç½²"
        ibus-daemon -drx
      fi
    else
      # æç¤ºç”¨æˆ·é‡æ–°è¿›è¡Œéƒ¨ç½²
      log INFO "æ›´æ–°å®Œæˆã€‚è¯·æ‰‹åŠ¨é‡æ–°éƒ¨ç½² rime"
    fi
  else
    log INFO "æ‚¨ç›®å‰æ— éœ€æ›´æ–°"
  fi
}

main "$@"
