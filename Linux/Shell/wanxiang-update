#!/usr/bin/env bash

set -euo pipefail

#### é…ç½® Rime éƒ¨ç½²ç›®å½• ####
# æ”¯æŒç›¸å¯¹è·¯å¾„ã€ç»å¯¹è·¯å¾„ã€æ‹“å±•å˜é‡
# ä¾‹å¦‚ "/home/user/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "$HOME/.local/share/fcitx5/rime"
# ä¾‹å¦‚ "${XDG_DATA_HOME:-$HOME/.local/share}/fcitx5/rime"

DEPLOY_DIR=""

######### é…ç½®ç»“æŸ #########

# å…¨å±€å¸¸é‡
readonly CNB_API="https://cnb.cool/amzxyz/rime-wanxiang/-/releases"
readonly SCHEMA_API="https://api.github.com/repos/amzxyz/rime_wanxiang/releases"
readonly GRAM_API="https://api.github.com/repos/amzxyz/RIME-LMDG/releases"
readonly TOOLS_API="https://api.github.com/repos/rimeinn/rime-wanxiang-update-tools/releases"
readonly FUZHU_LIST=("base" "flypy" "hanxin" "moqi" "tiger" "wubi" "zrm" "shouyou")
readonly DELETE_FILES=("ç®€çº¯+.trime.yaml" "squirrel.yaml" "weasel.yaml"
  "README.md" "CHANGELOG.md" "version.txt" "custom_phrase.txt")
readonly UPDATE_TOOLS_VERSION="DEFAULT_UPDATE_TOOLS_VERSION_TAG"
readonly CONNECTION_TIMEOUT="10"
readonly MAX_RETRIES="3"

# å…¨å±€å˜é‡
TEMP_DIR=$(mktemp -d /tmp/wanxiang-update-XXXXXX)
NEEDED_DEPLOY="false"
COLOR_OUTPUT="true"

# æ—¥å¿—ä¸é”™è¯¯å¤„ç†
log() {
  if [[ "$COLOR_OUTPUT" == "true" ]]; then
    local red="\033[0;31m" green="\033[0;32m" yellow="\033[0;33m" nc="\033[0m"
    local level="$1" color="$nc"
    case "$level" in
    INFO) color="$green" ;;
    WARN) color="$yellow" ;;
    ERROR) color="$red" ;;
    esac
    shift
    printf "${color}[%s] %s${nc}\n" "$level" "$*"
  else
    local level="$1"
    shift
    printf "[%s] %s\n" "$level" "$*"
  fi
}

error_exit() {
  log ERROR "$*"
  cleanup
  exit 1
}

cleanup() {
  if [[ -d "$TEMP_DIR" ]]; then
    rm -rf "$TEMP_DIR" || log WARN "æ¸…ç†ç¼“å­˜æ–‡ä»¶å¤±è´¥"
  fi
}

# å¸¦é‡è¯•çš„curlè¯·æ±‚ - ä¸“é—¨å¤„ç† set -e ç¯å¢ƒ
curl_with_retry() {
  local url="$1" output_file="$2" retries="0" success="false" curl_exit_code="0"

  # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
  mkdir -p "$(dirname "$output_file")"

  while [[ "$retries" -lt "$MAX_RETRIES" && "$success" == "false" ]]; do
    # åˆ é™¤å¯èƒ½å­˜åœ¨çš„éƒ¨åˆ†ä¸‹è½½æ–‡ä»¶
    if [[ -f "$output_file" ]]; then
      rm -f "$output_file" 2>/dev/null || :
    fi

    # ä½¿ç”¨ç‰¹æ®Šè¯­æ³•é˜²æ­¢ curl å¤±è´¥å¯¼è‡´è„šæœ¬é€€å‡º
    set +e # ä¸´æ—¶ç¦ç”¨ set -e
    curl -f -sL --connect-timeout "$CONNECTION_TIMEOUT" -o "$output_file" "$url"
    curl_exit_code=$?
    set -e # é‡æ–°å¯ç”¨ set -e

    if [[ "$curl_exit_code" -eq "0" && -f "$output_file" ]]; then
      success="true"
    else
      retries=$((retries + 1))
      if [[ "$retries" -lt "$MAX_RETRIES" ]]; then
        log WARN "è¯·æ±‚å¤±è´¥ (curl é€€å‡ºä»£ç : $curl_exit_code)ï¼Œæ­£åœ¨é‡è¯• ($retries/$MAX_RETRIES)..."
        sleep 2
      fi
    fi
  done

  if [[ "$success" == "false" ]]; then
    # æ¸…ç†å¯èƒ½çš„éƒ¨åˆ†æ–‡ä»¶
    if [[ -f "$output_file" ]]; then
      rm -f "$output_file"
    fi
    error_exit "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: $url (å·²é‡è¯• $MAX_RETRIES æ¬¡ï¼Œæœ€åé€€å‡ºä»£ç : $curl_exit_code)"
  fi

  return 0
}

# æ£€æŸ¥ç½‘ç»œè¿æ¥
check_network_connection() {
  local mirror="$1"

  if [[ "$mirror" == "github" ]]; then
    log INFO "æ£€æŸ¥ GitHub è¿æ¥çŠ¶æ€"
    set +e
    curl -sL --connect-timeout 5 "https://api.github.com" >/dev/null
    local github_api_status=$?
    curl -sL --connect-timeout 5 "https://github.com" >/dev/null
    local github_status=$?
    set -e

    if [[ "$github_api_status" -ne "0" ]]; then
      error_exit "æ— æ³•è¿æ¥åˆ° GitHub API, curl é€€å‡ºä»£ç : $github_api_status, è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ"
    elif [[ "$github_status" -ne "0" ]]; then
      error_exit "æ— æ³•è¿æ¥åˆ° GitHub, curl é€€å‡ºä»£ç : $github_status, è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ"
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    log INFO "æ£€æŸ¥ CNB è¿æ¥çŠ¶æ€"
    set +e
    curl -sL --connect-timeout 5 "https://cnb.cool" >/dev/null
    local cnb_status=$?
    set -e

    if [[ "$cnb_status" -ne "0" ]]; then
      error_exit "æ— æ³•è¿æ¥åˆ° CNB, curl é€€å‡ºä»£ç : $cnb_status, è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œ"
    fi
  fi
}

deps_check() {
  for _cmd in curl jq unzip find; do
    command -v "$_cmd" >/dev/null || error_exit "ç¼ºå°‘å¿…è¦ä¾èµ–ï¼š$_cmd"
  done
}

fuzhu_check() {
  local fuzhu_check="$1"
  for _fuzhu in "${FUZHU_LIST[@]}"; do
    if [[ "$fuzhu_check" == "$_fuzhu" ]]; then
      return 0
    fi
  done
  return 1
}

show_help() {
  cat <<EOF
Usage: $0 [OPTIONS]

é€‰é¡¹:
  --mirror [github|cnb]     é€‰æ‹©ä¸‹è½½æº (é»˜è®¤: github)
  --depdir DIR              è®¾ç½®éƒ¨ç½²ç›®å½• (å¿…éœ€)
  --inputime [fcitx5|ibus]  è®¾ç½®è¾“å…¥æ³•å¹³å°
  --schema [base|pro]       æ›´æ–°æ–¹æ¡ˆç±»å‹
  --fuzhu FUZHU             æ›´æ–°è¾…åŠ©ç è¡¨ (base|flypy|hanxin|moqi|tiger|wubi|zrm|shouyou)
  --dict                    æ›´æ–°è¯å…¸
  --gram                    æ›´æ–°è¯­æ³•æ¨¡å‹
  --no-color                ç¦ç”¨å½©è‰²è¾“å‡º
  --help                    æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

ç¤ºä¾‹:
  $0 --depdir "\$HOME/.local/share/fcitx5/rime" --schema base --fuzhu base --dict
  $0 --mirror cnb --depdir "\$HOME/.config/ibus/rime" --schema pro --fuzhu flypy --gram

æ³¨æ„:
  å¿…é¡»è‡³å°‘æŒ‡å®šä¸€ä¸ªæ›´æ–°é¡¹ç›®: --schema, --dict æˆ– --gram
  ä½¿ç”¨ --schema æˆ– --dict æ—¶å¿…é¡»åŒæ—¶ä½¿ç”¨ --fuzhu
EOF
}

exclude_file_check() {
  if [[ ! -f "$DEPLOY_DIR/custom/user_exclude_file.txt" ]]; then
    log WARN "$DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶ä¸å­˜åœ¨"
    log WARN "è¯¥æ–‡ä»¶ç”¨äºåœ¨æ›´æ–°æ—¶ä¿ç•™å¿…è¦çš„é¡¹ç›®"
    log WARN "æˆ‘ä»¬å¯ä»¥ä»æ¨¡æ¿ç”Ÿæˆä¸€ä¸ªåŒ…å«å¤§éƒ¨åˆ†éœ€è¦æ’é™¤çš„é¡¹ç›®çš„æ–‡ä»¶"
    log WARN "æ‚¨éœ€è¦ç”Ÿæˆä¸€ä¸ªé¢„è®¾æ–‡ä»¶å—ï¼Ÿ"

    local _createexcludefile
    read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™): " _createexcludefile
    _createexcludefile="${_createexcludefile:-NO}"

    if [[ "$_createexcludefile" == "YES" ]]; then
      mkdir -p "$DEPLOY_DIR/custom"
      cat >"$DEPLOY_DIR/custom/user_exclude_file.txt" <<"EOF"
#### ä»¥ä¸‹å†…å®¹è¯·ä¸è¦æ”¹åŠ¨ï¼Œé™¤éä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ ####
# æ’é™¤æ–‡ä»¶æœ¬èº«
custom/user_exclude_file.txt
# ç”¨æˆ·æ•°æ®åº“ä¸ custom æ–‡ä»¶
*.userdb
*.custom.yaml
# éƒ¨ç½²ä¿¡æ¯
installation.yaml
user.yaml
#### ä»¥ä¸Šå†…å®¹è¯·ä¸è¦æ”¹åŠ¨ï¼Œé™¤éä½ çŸ¥é“è‡ªå·±åœ¨åšä»€ä¹ˆ ####
########### è¿™è¡Œä»¥ä¸‹å†™å…¥ä½ çš„è‡ªå®šä¹‰æ’é™¤é¡¹ ###########

EOF
      log INFO "å·²åˆ›å»º $DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶"
      log INFO "è¯·æŸ¥çœ‹è¯¥æ–‡ä»¶ï¼Œç¡®è®¤æ‰€æœ‰é¡¹ç›®æ­£ç¡®åé‡æ–°è¿è¡Œè¯¥è„šæœ¬"
      error_exit "è¯·æŸ¥çœ‹ $DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶"
    else
      log WARN "æ‚¨æ²¡æœ‰è®¾ç½®æ’é™¤é¡¹ç›®åˆ—è¡¨ï¼"
      log WARN "æ‚¨éœ€è¦åˆ›å»ºçš„æ–‡ä»¶ä¸º $DEPLOY_DIR/custom/user_exclude_file.txt"
      log WARN "è¯·åœ¨è¯¥æ–‡ä»¶ä¸­å†™å…¥æ‚¨éœ€è¦æ’é™¤çš„é¡¹ç›®ï¼Œæ¯è¡Œä¸€ä¸ª"
      error_exit "$DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶ä¸å­˜åœ¨"
    fi
  fi

  if ! grep -Fxq "custom/user_exclude_file.txt" \
    "$DEPLOY_DIR/custom/user_exclude_file.txt"; then
    error_exit "æ‚¨æ²¡æœ‰å°† $DEPLOY_DIR/custom/user_exclude_file.txt æ–‡ä»¶è®¾ä¸ºæ’é™¤é¡¹ï¼"
  fi
}

script_check() {
  local mirror="$1"
  if [[ "$UPDATE_TOOLS_VERSION" =~ ^"DEFAULT" ]]; then
    log WARN "æ‚¨ä¼¼ä¹æ­£åœ¨ä½¿ç”¨é”™è¯¯çš„æ–‡ä»¶ï¼"
    log WARN "è¯·ä» Release é¡µé¢ä¸‹è½½æ­£å¼ç‰ˆï¼"
    error_exit "ç»ˆæ­¢æ“ä½œ"
  fi

  log INFO "å·¥å…·å½“å‰ç‰ˆæœ¬: $UPDATE_TOOLS_VERSION"

  if [[ "$mirror" == "github" ]]; then
    # æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
    check_network_connection "$mirror"

    log INFO "æ­£åœ¨æ£€æŸ¥æœ¬å·¥å…·æ˜¯å¦å­˜åœ¨æ›´æ–°"
    local local_version remote_version
    local_version="$UPDATE_TOOLS_VERSION"
    remote_version=$(
      curl -sL --connect-timeout 10 $TOOLS_API |
        jq -r '.[].tag_name' | grep -vE "rc" | sort -rV | head -n 1
    )

    if [[ "$remote_version" != "$local_version" ]]; then
      if printf "%s\n" "$remote_version" "$local_version" |
        sort -V | head -n1 | grep -q "$local_version$"; then
        log WARN "æ£€æµ‹åˆ°å·¥å…·æœ€æ–°ç‰ˆæœ¬ä¸º: $remote_version, å»ºè®®æ›´æ–°åç»§ç»­"
        log WARN "ä¸‹è½½åœ°å€: https://github.com/rimeinn/rime-wanxiang-update-tools/releases/download/$remote_version/rime-wanxiang-update-linux"
      fi
    else
      log INFO "å·¥å…·å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    # æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
    check_network_connection "$mirror"

    log WARN "ç”±äºæ‚¨æ­£åœ¨ä½¿ç”¨é•œåƒï¼Œæ— æ³•æ£€æŸ¥æœ¬å·¥å…·æ˜¯å¦å­˜åœ¨æ›´æ–°"
  fi
}

get_info() {
  local mirror="$1" version="$2" name="$3" info
  if [[ "$mirror" == "github" ]]; then
    info=$(
      jq -r --arg version "$version" --arg name "$name" '.[] |
      select( .tag_name == $version ) | .assets[] |
      select( .name | test( $name ) )' "$TEMP_DIR/github_$name.json"
    )
    echo "$info"
  elif [[ "$mirror" == "cnb" ]]; then
    info=$(
      jq -r --arg version "refs/tags/$version" --arg name "$name" '.releases[] |
      select( .tag_ref == $version ) | .assets[] |
      select( .name | test( $name ) )' "$TEMP_DIR/cnb.json"
    )
    echo "$info"
  fi
}

cache_api() {
  local mirror="$1" fuzhu="$2"
  if [[ "$mirror" == "github" ]]; then
    if [[ ! -f "$TEMP_DIR/github_$fuzhu.json" ]]; then
      local api_url
      if [[ "$fuzhu" != "lts" ]]; then
        api_url="$SCHEMA_API"
      else
        api_url="$GRAM_API"
      fi

      curl_with_retry "$api_url" "$TEMP_DIR/github_$fuzhu.json"
    fi
  elif [[ "$mirror" == "cnb" ]]; then
    if [[ ! -f "$TEMP_DIR/cnb.json" ]]; then
      curl_with_retry "$CNB_API" "$TEMP_DIR/cnb.json"
    fi
  fi
}

download_and_verify() {
  local url="$1" dest="$2" expected_size="$3" resource_name="$4"

  log INFO "æ­£åœ¨ä¸‹è½½ $resource_name"
  curl_with_retry "$url" "$dest"

  log INFO "æ­£åœ¨éªŒè¯æ–‡ä»¶å®Œæ•´æ€§"
  local actual_size
  actual_size=$(stat -c %s "$dest" 2>/dev/null || echo 0)

  if [[ "$actual_size" -ne "$expected_size" ]]; then
    log ERROR "æœŸæœ›æ–‡ä»¶å¤§å°: $expected_size, å®é™…æ–‡ä»¶å¤§å°: $actual_size"
    # åˆ é™¤æŸåçš„æ–‡ä»¶
    rm -f "$dest"
    error_exit "$resource_name ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•ï¼"
  fi
}

update_schema() {
  local mirror="$1" fuzhu="$2" gram="$3"
  # ç¼“å­˜ API å“åº”
  cache_api "$mirror" "$fuzhu"

  # è·å–æœ¬åœ°ç‰ˆæœ¬å·
  local local_version remote_version
  if [[ -f "$DEPLOY_DIR/lua/wanxiang.lua" ]]; then
    local_version=$(grep "wanxiang.version" "$DEPLOY_DIR/lua/wanxiang.lua" | awk -F '"' '{print $2}')
    [[ "$local_version" == v* ]] || local_version="v$local_version"
  else
    local_version="v0"
  fi

  # è·å–è¿œç¨‹ç‰ˆæœ¬å·
  if [[ "$mirror" == "github" ]]; then
    remote_version=$(
      jq -r '.[].tag_name' "$TEMP_DIR/github_$fuzhu.json" |
        grep -vE "dict-nightly" | sort -rV | head -n 1
    )
  elif [[ "$mirror" == "cnb" ]]; then
    remote_version=$(
      jq -r '.releases[].tag_ref' \
        "$TEMP_DIR/cnb.json" | grep -vE "model" | sort -rV | head -n 1
    )
    remote_version="${remote_version#"refs/tags/"}"
  fi

  [[ "$remote_version" == v* ]] || remote_version="v$remote_version"

  if [[ "$remote_version" != "$local_version" ]]; then
    if printf "%s\n" "$remote_version" "$local_version" |
      sort -V | head -n1 | grep -q "$local_version$"; then
      log INFO "æœ¬åœ°æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $local_version"
      log INFO "è¿œç¨‹æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $remote_version, ä»¥ä¸‹å†…å®¹ä¸ºæ›´æ–°æ—¥å¿—"
      local changelog
      if [[ "$mirror" == "github" ]]; then
        changelog=$(
          jq -r --arg version "$remote_version" '.[] |
        select( .tag_name == $version ) | .body' "$TEMP_DIR/github_$fuzhu.json"
        )
      elif [[ "$mirror" == "cnb" ]]; then
        changelog=$(
          jq -r --arg version "refs/tags/$remote_version" '.releases[] |
        select( .tag_ref == $version ) | .body' "$TEMP_DIR/cnb.json"
        )
      fi

      echo -e "$changelog" | sed -n '/## ğŸ“ æ›´æ–°æ—¥å¿—/,/## ğŸš€ ä¸‹è½½å¼•å¯¼/p' | head -n -1
      sleep 3

      log INFO "å¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶"
      local schemaurl schemaname remote_size
      if [[ "$mirror" == "github" ]]; then
        schemaurl=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.browser_download_url')
        remote_size=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.size')
      elif [[ "$mirror" == "cnb" ]]; then
        schemaurl=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.path')
        schemaurl="https://cnb.cool$schemaurl"
        remote_size=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.size_in_byte')
      fi

      schemaname=$(get_info "$mirror" "$remote_version" "$fuzhu" | jq -r '.name')

      download_and_verify "$schemaurl" "$TEMP_DIR/$schemaname" "$remote_size" "æ–¹æ¡ˆæ–‡ä»¶"

      log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°æ–¹æ¡ˆæ–‡ä»¶"
      unzip -q "$TEMP_DIR/$schemaname" -d "$TEMP_DIR/${schemaname%.zip}"

      # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
      for _file in "${DELETE_FILES[@]}"; do
        if [[ -f "$TEMP_DIR/${schemaname%.zip}/$_file" ]]; then
          rm -rf "${TEMP_DIR:?}/${schemaname%.zip}/${_file:?}"
        fi
      done

      # å¤‡ä»½æ’é™¤æ–‡ä»¶
      while IFS= read -r _line; do
        # è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ
        [[ "$_line" == \#* || -z "$_line" ]] && continue

        # å¯¹äºæ‰€æœ‰æ¨¡å¼ï¼ˆåŒ…æ‹¬é€šé…ç¬¦å’Œéé€šé…ç¬¦ï¼‰ï¼Œç»Ÿä¸€ä½¿ç”¨findå¤„ç†
        local exclude_file rel_path
        while IFS= read -r -d '' exclude_file; do
          if [[ -e "$exclude_file" ]]; then
            # è®¡ç®—ç›¸å¯¹è·¯å¾„
            rel_path="${exclude_file#"$DEPLOY_DIR/"}"
            # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶å¤åˆ¶æ–‡ä»¶
            mkdir -p "$(dirname "$TEMP_DIR/${schemaname%.zip}/$rel_path")"
            cp -rf "$exclude_file" "$TEMP_DIR/${schemaname%.zip}/$rel_path"
            log INFO "å·²æˆåŠŸå¤‡ä»½æ–‡ä»¶/ç›®å½•: $rel_path"
          fi
        done < <(find "$DEPLOY_DIR" -path "$DEPLOY_DIR/$_line" \
          ! -path "$DEPLOY_DIR/sync/*" ! -path "$DEPLOY_DIR/custom/*.custom.yaml" -print0 2>/dev/null)
      done <"$DEPLOY_DIR/custom/user_exclude_file.txt"

      # å•ç‹¬å¤„ç†è¯­æ³•æ¨¡å‹
      if [[ "$gram" != "true" && -f "$DEPLOY_DIR/wanxiang-lts-zh-hans.gram" ]]; then
        cp -rf "$DEPLOY_DIR/wanxiang-lts-zh-hans.gram" \
          "$TEMP_DIR/${schemaname%.zip}/wanxiang-lts-zh-hans.gram"
      fi

      # å®‰å…¨åˆ é™¤å¹¶å¤åˆ¶æ–‡ä»¶
      if [[ -d "$DEPLOY_DIR" ]]; then
        rm -rf "${DEPLOY_DIR:?}"/*
      fi
      cp -rf "$TEMP_DIR/${schemaname%.zip}"/* "$DEPLOY_DIR/"

      NEEDED_DEPLOY="true"
      log INFO "æ–¹æ¡ˆæ–‡ä»¶æ›´æ–°æˆåŠŸ"
    fi
  else
    log INFO "æœ¬åœ°æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $local_version"
    log INFO "è¿œç¨‹æ–¹æ¡ˆæ–‡ä»¶ç‰ˆæœ¬å·ä¸º $remote_version, æ‚¨ç›®å‰æ— éœ€æ›´æ–°"
  fi
}

update_dict() {
  local mirror="$1" fuzhu="$2"
  # ç¼“å­˜ API å“åº”
  cache_api "$mirror" "$fuzhu"

  local local_date remote_date
  if [[ -f "$DEPLOY_DIR/dicts/chengyu.txt" ]]; then
    local_date=$(stat -c %Z "$DEPLOY_DIR/dicts/chengyu.txt")
  else
    local_date=0
  fi

  if [[ "$mirror" == "github" ]]; then
    remote_date=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.updated_at')
  elif [[ "$mirror" == "cnb" ]]; then
    remote_date=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.updated_at')
  fi

  remote_date=$(date -d "$remote_date" +%s)

  if [[ $remote_date -gt $local_date ]]; then
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $local_date"
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $remote_date"
    local dicturl dictname remote_size
    if [[ "$mirror" == "github" ]]; then
      dicturl=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.browser_download_url')
      dictname=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.name')
      remote_size=$(get_info "$mirror" "dict-nightly" "$fuzhu" | jq -r '.size')
    elif [[ "$mirror" == "cnb" ]]; then
      dicturl=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.path')
      dicturl="https://cnb.cool$dicturl"
      dictname=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.name')
      remote_size=$(get_info "$mirror" "v1.0.0" "$fuzhu" | jq -r '.size_in_byte')
    fi

    download_and_verify "$dicturl" "$TEMP_DIR/$dictname" "$remote_size" "è¯å…¸æ–‡ä»¶"

    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°è¯å…¸æ–‡ä»¶"
    unzip -q "$TEMP_DIR/$dictname" -d "$TEMP_DIR/${dictname%.zip}"

    mkdir -p "$DEPLOY_DIR/dicts"
    cp -rf "$TEMP_DIR/${dictname%.zip}"/* "$DEPLOY_DIR/dicts"

    NEEDED_DEPLOY="true"
    log INFO "è¯å…¸æ–‡ä»¶æ›´æ–°æˆåŠŸ"
  else
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $local_date"
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯å…¸æ–‡ä»¶æœ€åæ›´æ–°äº $remote_date, æ‚¨ç›®å‰æ— éœ€æ›´æ–°"
  fi
}

update_gram() {
  local mirror="$1"
  # ç¼“å­˜ API å“åº”
  cache_api "$mirror" "lts"

  local local_date remote_date gramname="wanxiang-lts-zh-hans.gram"
  if [[ -f "$DEPLOY_DIR/$gramname" ]]; then
    local_date=$(stat -c %Z "$DEPLOY_DIR/$gramname")
  else
    local_date=0
  fi

  if [[ "$mirror" == "github" ]]; then
    remote_date=$(get_info "$mirror" "LTS" "lts" | jq -r '.updated_at')
  elif [[ "$mirror" == "cnb" ]]; then
    remote_date=$(get_info "$mirror" "model" "lts" | jq -r '.updated_at')
  fi

  remote_date=$(date -d "$remote_date" +%s)

  if [[ $remote_date -gt $local_date ]]; then
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $local_date"
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $remote_date"
    local gramurl remote_size
    if [[ "$mirror" == "github" ]]; then
      gramurl=$(get_info "$mirror" "LTS" "lts" | jq -r '.browser_download_url')
      remote_size=$(get_info "$mirror" "LTS" "lts" | jq -r '.size')
    elif [[ "$mirror" == "cnb" ]]; then
      gramurl=$(get_info "$mirror" "model" "lts" | jq -r '.path')
      gramurl="https://cnb.cool$gramurl"
      remote_size=$(get_info "$mirror" "model" "lts" | jq -r '.size_in_byte')
    fi

    download_and_verify "$gramurl" "$TEMP_DIR/$gramname" "$remote_size" "è¯­æ³•æ¨¡å‹"

    log INFO "éªŒè¯æˆåŠŸï¼Œå¼€å§‹æ›´æ–°è¯­æ³•æ¨¡å‹"
    cp -rf "$TEMP_DIR/$gramname" "${DEPLOY_DIR}/$gramname"

    NEEDED_DEPLOY="true"
    log INFO "è¯­æ³•æ¨¡å‹æ›´æ–°æˆåŠŸ"
  else
    local_date=$(date -d "@$local_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "æœ¬åœ°è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $local_date"
    remote_date=$(date -d "@$remote_date" +"%Y-%m-%d %H:%M:%S")
    log INFO "è¿œç¨‹è¯­æ³•æ¨¡å‹æœ€åæ›´æ–°äº $remote_date, æ‚¨ç›®å‰æ— éœ€æ›´æ–°"
  fi
}

main() {
  # è„šæœ¬é€€å‡ºæ¸…ç†ä¸´æ—¶ç›®å½•
  trap cleanup EXIT INT TERM

  # æ¬¢è¿è¯­
  log INFO "æ¬¢è¿ä½¿ç”¨ä¸‡è±¡æ–¹æ¡ˆæ›´æ–°åŠ©æ‰‹"

  # æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
  if [[ "$EUID" -eq 0 ]]; then
    error_exit "è¯·ä¸è¦ä½¿ç”¨ root èº«ä»½è¿è¡Œè¯¥è„šæœ¬ï¼"
  fi

  # æ£€æŸ¥å¿…è¦çš„ä¾èµ–
  deps_check

  # å¤„ç†ç”¨æˆ·è¾“å…¥
  local mirror="" depdir="" inputime="" schema="" fuzhu="" dict="false" gram="false"

  # è§£æå‘½ä»¤è¡Œå‚æ•°
  while [[ "$#" -gt 0 ]]; do
    case $1 in
    --mirror)
      if [[ -n "$mirror" ]]; then
        error_exit "é€‰é¡¹ mirror éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "cnb" && "$1" != "github" ]]; then
        error_exit "é€‰é¡¹ mirror çš„å‚æ•°åªèƒ½ä¸º github æˆ– cnb"
      else
        mirror="$1"
      fi
      ;;
    --depdir)
      if [[ -n "$depdir" ]]; then
        error_exit "é€‰é¡¹ depdir éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      DEPLOY_DIR="$1"
      ;;
    --inputime)
      if [[ -n "$inputime" ]]; then
        error_exit "é€‰é¡¹ inputime éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "fcitx5" && "$1" != "ibus" ]]; then
        error_exit "é€‰é¡¹ inputime çš„å‚æ•°åªèƒ½ä¸º fcitx5 æˆ– ibus"
      else
        inputime="$1"
      fi
      ;;
    --schema)
      if [[ -n "$schema" ]]; then
        error_exit "é€‰é¡¹ schema éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if [[ "$1" != "base" && "$1" != "pure" && "$1" != "pro" ]]; then
        error_exit "é€‰é¡¹ schema çš„å‚æ•°åªèƒ½ä¸º base/pro ä¹‹ä¸€"
      else
        schema="$1"
      fi
      ;;
    --fuzhu)
      if [[ -n "$fuzhu" ]]; then
        error_exit "é€‰é¡¹ fuzhu éœ€è¦å‚æ•°ï¼"
      else
        shift
      fi
      if fuzhu_check "$1"; then
        fuzhu="$1"
      else
        error_exit "é€‰é¡¹ fuzhu çš„å‚æ•°åªèƒ½ä¸º ${FUZHU_LIST[*]} å…¶ä¸­ä¹‹ä¸€"
      fi
      ;;
    --dict)
      dict="true"
      ;;
    --gram)
      gram="true"
      ;;
    --no-color)
      COLOR_OUTPUT="false"
      ;;
    --help)
      show_help
      exit 0
      ;;
    *)
      log WARN "æœªçŸ¥å‚æ•°: $1"
      log WARN "ä½¿ç”¨ --help æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯"
      error_exit "å‚æ•°è¾“å…¥é”™è¯¯: $1"
      ;;
    esac
    shift
  done

  # åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†éƒ¨ç½²ç›®å½•
  if [[ -z "$DEPLOY_DIR" ]]; then
    error_exit "è¯·ä½¿ç”¨ --depdir å‚æ•°è®¾ç½®éƒ¨ç½²ç›®å½•ï¼"
  fi

  # å¤„ç†éƒ¨ç½²ç›®å½•
  DEPLOY_DIR=$(eval echo "$DEPLOY_DIR")

  if [[ ! -d "$DEPLOY_DIR" ]]; then
    log WARN "éƒ¨ç½²ç›®å½• $DEPLOY_DIR ä¸å­˜åœ¨ï¼Œæ‚¨è¦åˆ›å»ºå®ƒå—ï¼Ÿ"
    read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™): " _check
    if [[ "$_check" == "YES" ]]; then
      log WARN "æ‚¨çœŸçš„è¦åˆ›å»ºè¯¥ç›®å½•å—ï¼Ÿæ‚¨ç¡®å®šæ‚¨çš„è®¾ç½®æ­£ç¡®å—ï¼Ÿ"
      read -rp "è¯·è¾“å…¥ YES æˆ– NO (åŒºåˆ†å¤§å°å†™): " _check_again
      [[ "$_check_again" == "YES" ]] || error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
      mkdir -p "$DEPLOY_DIR"
    else
      error_exit "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ"
    fi
  fi

  # æ’é™¤é¡¹ç›®åˆ—è¡¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
  exclude_file_check

  # è‡³å°‘éœ€è¦ä¸€ä¸ªæ›´æ–°é¡¹ç›®
  if [[ -z "$schema" && "$dict" == "false" && "$gram" == "false" ]]; then
    error_exit "è¯·è‡³å°‘æŒ‡å®šä¸€ä¸ªæ›´æ–°é¡¹ç›®ï¼š--schemaã€--dict æˆ– --gram"
  fi

  # æ£€æŸ¥ schema å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ -n "$schema" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ schema ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi

  # æ£€æŸ¥ dict å’Œ fuzhu æ˜¯å¦åŒæ—¶å­˜åœ¨
  if [[ "$dict" == "true" && -z "$fuzhu" ]]; then
    error_exit "é€‰é¡¹ dict ä¸é€‰é¡¹ fuzhu å¿…é¡»åŒæ—¶ä½¿ç”¨"
  fi

  # æ£€æŸ¥å½“ schema ä¸º base æˆ– pure æ—¶ï¼Œfuzhu æ˜¯å¦ä¹Ÿä¸º base
  if [[ "$schema" == "base" && "$fuzhu" != "base" ]]; then
    error_exit "å½“é€‰é¡¹ schema ä¸º base æ—¶ï¼Œé€‰é¡¹ fuzhu å¿…é¡»ä¸º base"
  fi

  [[ -n "$mirror" ]] || mirror="github"

  # è„šæœ¬è‡ªæ£€
  script_check "$mirror"

  # å¼€å§‹æ›´æ–°
  [[ -z "$schema" ]] || update_schema "$mirror" "$fuzhu" "$gram"
  [[ "$dict" == "false" ]] || update_dict "$mirror" "$fuzhu"
  [[ "$gram" == "false" ]] || update_gram "$mirror"

  # è‡ªåŠ¨éƒ¨ç½²
  if [[ "$NEEDED_DEPLOY" == "true" ]]; then
    if [[ "$inputime" == "fcitx5" ]]; then
      if command -v qdbus6 >/dev/null; then
        log INFO "æ›´æ–°å®Œæˆã€‚å·²æ£€æµ‹åˆ° Fcitx5 å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£åœ¨è‡ªåŠ¨éƒ¨ç½²"
        qdbus6 org.fcitx.Fcitx5 /controller org.fcitx.Fcitx.Controller1.SetConfig "fcitx://config/addon/rime/deploy" ""
      else
        log INFO "æ›´æ–°å®Œæˆã€‚è¯·æ‰‹åŠ¨é‡æ–°éƒ¨ç½² Fcitx5"
      fi
    elif [[ "$inputime" == "ibus" ]]; then
      if command -v ibus-daemon >/dev/null; then
        log INFO "æ›´æ–°å®Œæˆã€‚å·²æ£€æµ‹åˆ° iBus å®ˆæŠ¤è¿›ç¨‹ï¼Œæ­£åœ¨è‡ªåŠ¨éƒ¨ç½²"
        ibus-daemon -drx
      else
        log INFO "æ›´æ–°å®Œæˆã€‚è¯·æ‰‹åŠ¨é‡æ–°éƒ¨ç½² iBus"
      fi
    else
      # æç¤ºç”¨æˆ·é‡æ–°è¿›è¡Œéƒ¨ç½²
      log INFO "æ›´æ–°å®Œæˆã€‚è¯·æ‰‹åŠ¨é‡æ–°éƒ¨ç½² rime"
    fi
  else
    log INFO "æ‚¨ç›®å‰æ— éœ€æ›´æ–°"
  fi
}

main "$@"
